<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="description" content="" />

  <title>
    
      Computable properties for any LINQ provider &middot; Hazzik's blog
    
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="47dSjgZrewzbFXAnLPznjg7c_FE_SuVbOT0IEKn6h64" />
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="tag-cloud">
      <a href="/tag/dot-net" class="set-1">.NET</a> <a href="/tag/asp-dot-net-mvc" class="set-5">ASP.NET MVC</a> <a href="/tag/best-practicies" class="set-1">Best practicies</a> <a href="/tag/blog" class="set-1">Blog</a> <a href="/tag/computed-properties" class="set-1">Computed Properties</a> <a href="/tag/dataannotations" class="set-1">DataAnnotations</a> <a href="/tag/decompiler" class="set-1">Decompiler</a> <a href="/tag/delegate" class="set-1">Delegate</a> <a href="/tag/drop-down-lists" class="set-1">Drop down lists</a> <a href="/tag/git" class="set-5">Git</a> <a href="/tag/git-alias" class="set-1">Git Alias</a> <a href="/tag/linq" class="set-1">LINQ</a> <a href="/tag/mvcextensions" class="set-1">MvcExtensions</a> <a href="/tag/nhibernate" class="set-5">NHibernate</a> <a href="/tag/persistent-tree" class="set-1">Persistent-Tree</a> <a href="/tag/renderaction" class="set-1">RenderAction</a> <a href="/tag/tree" class="set-1">Tree</a> <a href="/tag/tree-hierarchy" class="set-1">Tree-Hierarchy</a> <a href="/tag/tree-structures" class="set-1">Tree-Structures</a>
    </div>
    <div class="sidebar-about">

      <h1><a href="/">Hazzik's blog</a></h1>
      <p class="lead"><a href="/"></a></p>

    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
        <a href="/">Home</a>
      </li>

      

      
      
            <li class="sidebar-nav-item">
              <a href="/about/">About</a>
            </li>
      
            <li class="sidebar-nav-item">
              <a href="/books/">Books</a>
            </li>
      
    </ul>
    <ul class="sidebar-social">
      <li class="sidebar-social-item"><a href="http://twitter.com/hazzik"><i class="fa fa-twitter"></i></a></li>
      &middot;
      <li class="sidebar-social-item"><a href="http://github.com/hazzik"><i class="fa fa-github"></i></a></li>
      &middot;
      <li class="sidebar-social-item"><a href="http://linkedin.com/in/hazzik"><i class="fa fa-linkedin"></i></a></li>
    </ul>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post hentry">
  <h1 class="post-title entry-title">
    <a href="http://github.com/hazzik/alexzaytsev.me/edit/master/_posts/tumblr/2013-03-05-computable-properties-for-any-linq-provider.md"><i class="fa fa-edit"></i></a> Computable properties for any LINQ provider
  </h1>
  <ul class="post-info">
    <li><i class="fa fa-calendar"></i><time datetime="2013-03-05T09:31:14+12:00" class="published"> 05 Mar 2013 </time></li>
    <li class="tags"><i class="fa fa-tags"></i> <a href="/tag/nhibernate" rel="tag">NHibernate</a>, <a href="/tag/linq" rel="tag">LINQ</a>, <a href="/tag/computed-properties" rel="tag">Computed Properties</a>, <a href="/tag/decompiler" rel="tag">Decompiler</a>, <a href="/tag/delegate" rel="tag">Delegate</a></li>
    <li><i class="fa fa-comments"></i> <a href="/2013/03/05/computable-properties-for-any-linq-provider/#disqus_thread" data-disqus-identifier="/2013/03/05/computable-properties-for-any-linq-provider/">0 comments</a></li>
  </ul>
  <div class="entry-content">
    <p>In this blog post I want to present a little library which I wrote a while ago. This library can decompile methods to their λ-representation.</p>

<h1>Why</h1>

<p>Sometimes you need to use computable properties in LINQ queries, for example you have Employee class with computable property FullName</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">Employee</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FirstName</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">LastName</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>And now your manager comes to you and says that we need to have ability to search by employee’s full name. And you without any thinking write following query:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">employees</span> <span class="p">=</span> <span class="p">(</span><span class="n">from</span> <span class="n">employee</span> <span class="k">in</span> <span class="n">db</span><span class="p">.</span><span class="n">Employees</span>
                 <span class="nf">where</span> <span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">FirstName</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">employee</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span> <span class="p">==</span> <span class="s">"Test User"</span>
                 <span class="n">select</span> <span class="n">employee</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
</code></pre></div>
<p>Yes, with such simple property as FullName it can work, but what will you do if field would be not simple as this one? For example there is one field from one of my previous projects, and it should be queryable!</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">WayPoint</span> 
<span class="p">{</span>
    <span class="c1">// all other is skipped due to clarity reasons
</span>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">IsValid</span>
    <span class="p">{</span>
        <span class="k">get</span> 
        <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">Account</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">||</span>
               <span class="p">(</span><span class="n">Role</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">Account</span><span class="p">.</span><span class="n">Role</span> <span class="p">==</span> <span class="n">Role</span><span class="p">)</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span>
               <span class="p">(</span><span class="n">StructuralUnit</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">Account</span><span class="p">.</span><span class="n">State</span><span class="p">.</span><span class="n">StructuralUnit</span> <span class="p">==</span> <span class="n">StructuralUnit</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This is much harder…</p>

<p>What do we have to solve such puzzles?</p>

<h1>&lt;formula&gt; element in NHibernate</h1>

<p>If you are using NHibernate then you can map this field as formula, but this way is full of big scare bears, and such code is hard to maintain, and the <code>&lt;formula&gt;</code> element supports only small subset of SQL, and if you are developing software which have to work with different RDBMS you have to be very-very careful.</p>

<p>It works only in NHibernate</p>

<h1><a href="http://damieng.com/blog/2009/06/24/client-side-properties-and-any-remote-linq-provider">Microsoft.Linq.Translations</a></h1>

<p>With this great and powerful library we would rewrite our class like this</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">Employee</span> 
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">CompiledExpression</span> <span class="n">fullNameExpression</span>
        <span class="p">=</span> <span class="n">DefaultTranslationOf</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">FullName</span><span class="p">).</span><span class="nf">Is</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">FirstName</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">e</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span> 
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">fullNameExpression</span><span class="p">.</span><span class="nf">Evaluate</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">employees</span> <span class="p">=</span> <span class="p">(</span><span class="n">from</span> <span class="n">employee</span> <span class="k">in</span> <span class="n">db</span><span class="p">.</span><span class="n">Employees</span>
                 <span class="n">where</span> <span class="n">employee</span><span class="p">.</span><span class="n">FullName</span> <span class="p">==</span> <span class="s">"Test User"</span>
                 <span class="n">select</span> <span class="n">employee</span><span class="p">).</span><span class="nf">WithTranslations</span><span class="p">().</span><span class="nf">ToList</span><span class="p">()</span>
</code></pre></div>
<p>All right, and the query looks good but the field declaration is terrible! And Evaluate compiles the λ-expression in runtime, which is no less terrible than the computable field decalaration.</p>

<p>And now meet my small library - DelegateDecompiler</p>

<h1>DelegateDecompiler</h1>

<p>The property should be marked with [Computed] attribute and it is all you need, and add <code>.Decompile()</code> method invocation to the query.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">class</span> <span class="nc">Employee</span> 
<span class="p">{</span>
    <span class="p">[</span><span class="n">Computed</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span> 
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FirstName</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">LastName</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">employees</span> <span class="p">=</span> <span class="p">(</span><span class="n">from</span> <span class="n">employee</span> <span class="k">in</span> <span class="n">db</span><span class="p">.</span><span class="n">Employees</span>
                 <span class="n">where</span> <span class="n">employee</span><span class="p">.</span><span class="n">FullName</span> <span class="p">==</span> <span class="s">"Test User"</span>
                 <span class="n">select</span> <span class="n">employee</span><span class="p">).</span><span class="nf">Decompile</span><span class="p">().</span><span class="nf">ToList</span><span class="p">()</span>
</code></pre></div>
<p>In my opinion it is gracefully (If you don’t blow your own horn, no one will do it for you). But bear in mind that the source of your computable property should be supported using LINQ provider.</p>

<h1>How does it work?</h1>

<p><code>.Decompile()</code> method finds all the properties and methods marked with <code>[Computed]</code> attribute and expand them to their source expressions. In other words the query above will become as following query:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">employees</span> <span class="p">=</span> <span class="p">(</span><span class="n">from</span> <span class="n">employee</span> <span class="k">in</span> <span class="n">db</span><span class="p">.</span><span class="n">Employees</span>
                 <span class="nf">where</span> <span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="n">FirstName</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">employee</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span> <span class="p">==</span> <span class="s">"Test User"</span>
                 <span class="n">select</span> <span class="n">employee</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
</code></pre></div>
<p>The library uses Mono.Reflection (GitHub, NuGet) as decompiler. The Mono.Reflection library is written by Jean-Baptiste Evain the creator of Mono.Cecil.</p>

<p>PS: This is an alpha version, use at your own risk.</p>

<h1>Links</h1>

<ul>
<li><a href="https://github.com/hazzik/DelegateDecompiler">Source code at GitHub</a></li>
<li><a href="https://nuget.org/packages/DelegateDecompiler">Nuget package</a></li>
</ul>

  </div>
</div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- alexzaytsev.me -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:15px"
     data-ad-client="ca-pub-6286543550478332"
     data-ad-slot="7799059444"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'hazzik-blog-en'; // required: replace example with your forum shortname
      var disqus_identifier = '/2013/03/05/computable-properties-for-any-linq-provider/';
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/10/19/git-filter-to-convert-spaces-to-tabs-and-vice-versa/">
            Git Filter to Convert Spaces to Tabs and Vice Versa
            <small>19 Oct 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/10/19/git-alias-to-apply-patch-from-url/">
            Git aliases to apply patches from url
            <small>19 Oct 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/07/04/learn-how-to-use-idcitionary-dot-trygetvalue/">
            Learn How to Use IDcitionary<,>.TryGetValue!
            <small>04 Jul 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'hazzik-blog-en'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<!-- Yandex.Metrika counter -->
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript"></script>
<script type="text/javascript">
try { var yaCounter25093751 = new Ya.Metrika({id:25093751,
          webvisor:true,
          clickmap:true,
          trackLinks:true,
          accurateTrackBounce:true});
} catch(e) { }
</script>
<noscript><div><img src="//mc.yandex.ru/watch/25093751" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

  </body>
</html>
